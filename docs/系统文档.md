# 零食小店库存管理系统 (SnackStock) 开发文档

## 1. 项目概述

本系统旨在利用现有的 **PC + 扫码枪** 硬件组合，替代手写账本或复杂 Excel 表格，实现零食商品的数字化管理，提高入库效率，并实时掌握库存与利润。

---

## 2. 技术架构选型

- **开发环境：** macOS（本地开发与联调）
- **生产环境：** Windows（门店实际运行）
- **部署方式：** Windows 拉取代码后本地打包，产出可双击启动程序
- **编程语言：** Python 3.13
- **图形界面：** PyQt6
- **数据库：** SQLite 3
- **扫码支持：** HID 模式（扫码枪模拟键盘输入）

### 2.1 发布与更新策略

- 当前采用手动发布，不实现在线自动更新。
- 流程：macOS 开发提交 -> Windows 拉取代码 -> Windows 本地打包。

---

## 3. 数据库逻辑设计

### 3.1 主数据库核心表

#### `products`（商品档案）

- `barcode`：主键
- `name`：商品名称
- `category`：商品分类
- `purchase_price`：进价
- `retail_price`：售价
- `min_stock`：安全库存

#### `stock_logs`（当月库存流水）

- `id`：自增主键
- `barcode`：商品条码
- `change_qty`：数量变动（入库为正，出库为负）
- `type`：类型（采购/销售等）
- `timestamp`：操作时间

#### `stock_totals`（当前库存快照）

- `barcode`：主键
- `current_qty`：当前库存

说明：库存查询和预警优先读取 `stock_totals`，不再依赖全量 `stock_logs` 聚合，便于历史流水拆分。

#### `expiry_management`（批次与保质期）

- `barcode`
- `batch_no`
- `expiry_date`
- `current_qty`

### 3.2 流水分文件归档策略

- 每次启动数据库层时，会将“当前月之前”的 `stock_logs` 迁移到 `archives/stock_logs_YYYY_MM.db`。
- 归档库中使用 `archived_stock_logs` 保存历史流水（包含商品名称、价格快照）。
- 主库保留当月流水 + 当前库存快照，降低主库膨胀速度。

---

## 4. 功能模块说明

### 4.1 入库

- 新增/更新商品档案
- 扫码入库（支持批次和过期日期）

### 4.2 出库

- 手动模式：条码前缀候选下拉，手动指定数量
- 扫码模式：扫描一次直接加入购物车，默认数量 1
- 购物车同条码自动合并，支持表格内改数量、移除
- 结算时校验库存，按到期优先扣减批次

### 4.3 库存与报表

- 库存表支持搜索与列排序
- 显示缺货/临期预警
- 支持日报统计与 CSV 导出
- 支持 UI 切换数据库文件

---

## 5. 后续可扩展方向

- 历史归档定期压缩
- 归档查询筛选器（跨月范围查询）
- 一键备份主库 + archives
