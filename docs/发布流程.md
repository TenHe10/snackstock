# SnackStock 发布流程（Windows 打包）

## 1. 目标与范围

本流程用于当前阶段的手动发布：

- 开发机（macOS）负责编码与提交
- 生产机（Windows）负责拉取代码与打包
- 暂不包含在线自动更新能力

---

## 2. 发布前准备

发布负责人在 Windows 机器确认以下内容：

1. 已安装 Git
2. 已安装 Python 3.13
3. 已安装 `uv`
4. 有可用目录用于存放发布产物

---

## 3. 拉取指定版本代码

在 Windows 机器执行：

```bash
git clone <仓库地址>
cd snackstock
git fetch --all --tags
git checkout <发布分支或发布标签>
```

发布建议使用 tag，例如：`v0.2.0`。

---

## 4. 安装依赖

在项目根目录执行：

```bash
uv sync --frozen
```

---

## 5. Windows 打包

### 5.1 一键打包（推荐）

在项目根目录双击或命令行执行：

```bash
build_windows.bat
```

脚本会自动：

1. 校验 `uv` 与 `uv.lock` 依赖
2. 清理旧构建目录
3. 基于固定 `SnackStock.spec` 执行 PyInstaller
4. 校验关键 Qt 运行时文件是否已打包

### 5.2 手动打包（备用）

在项目根目录执行：

```bash
uv run --with pyinstaller python -m PyInstaller --noconfirm --clean SnackStock.spec
```

打包后主要目录：

- `dist/SnackStock/`
- `dist/SnackStock/SnackStock.exe`

---

## 6. 产物整理与交付

建议创建发布目录（示例）：

- `release/SnackStock-v0.2.0/`

需要包含：

1. `SnackStock.exe` 及其运行依赖（建议整个 `dist/SnackStock/` 目录）
2. `使用说明.md`（从 `docs/使用说明.md` 导出/拷贝）
3. `员工快速上手.md`（从 `docs/员工快速上手.md` 导出/拷贝）
4. 版本说明（`CHANGELOG` 或发布说明文本）

说明：

- `database/inventory.db` 为运行期数据文件，不应作为固定初始数据覆盖门店旧数据。

---

## 7. 发布验收清单

发布前至少完成以下检查：

1. 双击 `SnackStock.exe` 可正常启动
2. 页面可正常切换（入库 / 出库 / 库存与报表）
3. 可新增商品并成功入库
4. 可扫码/输入条码加入购物车并完成结算
5. 预警区正常显示
6. 可导出日报 CSV
7. 重启程序后数据仍存在（验证 SQLite 持久化）

---

## 8. 升级与回滚（手动）

### 8.1 升级步骤

1. 备份门店当前 `database/inventory.db`
2. 用新版本程序目录替换旧程序目录（不要覆盖备份数据库）
3. 启动新版本，做一次最小功能验收

### 8.2 回滚步骤

1. 停止当前程序
2. 恢复上一版本程序目录
3. 恢复升级前备份的 `database/inventory.db`（如有需要）
4. 重新启动并验证

---

## 9. 后续优化建议（非当前范围）

1. 在 `pyproject.toml` 固定打包工具版本（`pyinstaller`、`pyinstaller-hooks-contrib`）
2. 在 `build_windows.bat` 增加版本号参数和产物归档
3. 增加安装包（如 Inno Setup）以生成桌面图标与卸载入口
